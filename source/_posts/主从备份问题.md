
title: 主从备份问题
date: 2017-10-25 10:57:57
tags: [youdaonote]
---

昨天同事聊起mysql的主从备份问题。我们都知道mysql的主从同步是通过binlog实现的，抛开已经成行的主从不说，如果要新增从库的话，那么具体是精准的copy数据库镜像，然后记录binlog位置的呢？如果说copy镜像的话，那么一定要停库或者锁表了，如果是copy主库的话，那势必会影响线上业务了。


参考了一些资料，自己脑袋也跟着转了一下，总结出以下几种情况。


1. 当前已经有了健壮的主从结构/或者是健壮的双热备，只需要新增一个从库。
- 将从库暂时停掉
- 进行这个mysql的所有数据的拷贝
- 在目标新从库修改server-id
- 启动新老从库
- 验证确认
2. 当前只有主库，前面并没有配置从库，但是已经有了binlog。
- 最稳妥的：停掉，copy，配置，重启。
- 使用mysqldump，这种最不推荐，因为会锁表，那么对于线上应用来说一样是会收到影响。反正都会影响线上，还不如停掉更为稳妥
- 使用xtrabackup进行备份，不锁表，不影响线上业务。具体参考[xtrabackup原理及实施](http://sofar.blog.51cto.com/353572/1313649)。大概流程如下图：
![](C:\Users\will\Pictures\xtrabakcup.png)
具体来说，首先在logfile中找到并记录最后一个checkpoint（“last checkpoint LSN”），然后开始从LSN的位置开始拷贝InnoDB的logfile到xtrabackup_logfile；然后开始拷贝全部的数据文件.ibd；在拷贝全部数据文件结束之后，才停止拷贝logfile。
因为**logfile里面记录全部的数据修改情况**，所以即使在备份过程中数据文件被修改过了，恢复时仍然能够通过解析xtrabackup_logfile保持数据的一致。


参考：
- http://sofar.blog.51cto.com/353572/1313649
- http://database.51cto.com/art/201507/483499.htm
- http://lizhenliang.blog.51cto.com/7876557/1612800
